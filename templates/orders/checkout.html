{% extends 'base.html' %}
{% load static %}

{% block title %}Finalizar Compra - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .checkout-progress {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 30px;
        position: relative;
    }
    
    .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        flex: 1;
        max-width: 200px;
    }
    
    .progress-step::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 50%;
        right: -50%;
        height: 2px;
        background: #dee2e6;
        z-index: 1;
    }
    
    .progress-step:last-child::before {
        display: none;
    }
    
    .progress-step.active::before {
        background: #007bff;
    }
    
    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #dee2e6;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 8px;
        position: relative;
        z-index: 2;
    }
    
    .progress-step.active .step-number {
        background: #007bff;
        color: white;
    }
    
    .progress-step.completed .step-number {
        background: #28a745;
        color: white;
    }
    
    .step-label {
        font-size: 0.9rem;
        text-align: center;
        color: #6c757d;
    }
    
    .progress-step.active .step-label {
        color: #007bff;
        font-weight: 600;
    }
    
    .checkout-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 25px;
    }
    
    .section-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 20px;
        color: #495057;
        display: flex;
        align-items: center;
    }
    
    .section-title i {
        margin-right: 10px;
        color: #007bff;
    }
    
    .form-floating {
        margin-bottom: 1rem;
    }
    
    .address-card {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 15px;
    }
    
    .address-card:hover {
        border-color: #007bff;
    }
    
    .address-card.selected {
        border-color: #007bff;
        background: #e3f2fd;
    }
    
    .address-card input[type="radio"] {
        position: absolute;
        opacity: 0;
    }
    
    .payment-method {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }
    
    .payment-method:hover {
        border-color: #007bff;
    }
    
    .payment-method.selected {
        border-color: #007bff;
        background: #e3f2fd;
    }
    
    .payment-method input[type="radio"] {
        margin-right: 15px;
        transform: scale(1.2);
    }
    
    .payment-icon {
        font-size: 2rem;
        margin-right: 15px;
        color: #007bff;
    }
    
    .payment-info {
        flex: 1;
    }
    
    .payment-title {
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .payment-description {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .order-summary {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 25px;
        position: sticky;
        top: 20px;
    }
    
    .order-item {
        display: flex;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #eee;
    }
    
    .order-item:last-child {
        border-bottom: none;
    }
    
    .item-image {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        margin-right: 15px;
    }
    
    .item-info {
        flex: 1;
    }
    
    .item-name {
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .item-details {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .item-price {
        font-weight: 600;
        color: #28a745;
    }
    
    .summary-line {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    
    .summary-line.total {
        font-weight: bold;
        font-size: 1.2rem;
        border-top: 1px solid #dee2e6;
        padding-top: 15px;
        margin-top: 15px;
    }
    
    .shipping-option {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .shipping-option:hover {
        border-color: #007bff;
    }
    
    .shipping-option.selected {
        border-color: #007bff;
        background: #e3f2fd;
    }
    
    .shipping-option input[type="radio"] {
        margin-right: 10px;
    }
    
    .shipping-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .shipping-details {
        flex: 1;
    }
    
    .shipping-name {
        font-weight: 600;
        margin-bottom: 3px;
    }
    
    .shipping-time {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .shipping-price {
        font-weight: 600;
        color: #28a745;
    }
    
    .coupon-input {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    
    .terms-checkbox {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        margin: 20px 0;
    }
    
    .place-order-btn {
        width: 100%;
        padding: 15px;
        font-size: 1.1rem;
        font-weight: 600;
        background: #28a745;
        border: none;
        border-radius: 8px;
        color: white;
        transition: all 0.3s;
    }
    
    .place-order-btn:hover:not(:disabled) {
        background: #218838;
        transform: translateY(-2px);
    }
    
    .place-order-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
    
    .security-badges {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .security-badge {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        color: #28a745;
    }
    
    .security-badge i {
        margin-right: 5px;
    }
    
    @media (max-width: 768px) {
        .checkout-progress {
            overflow-x: auto;
            padding: 0 20px;
        }
        
        .progress-step {
            min-width: 120px;
        }
        
        .order-summary {
            position: static;
            margin-top: 30px;
        }
        
        .security-badges {
            flex-direction: column;
            gap: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Progress Steps -->
    <div class="checkout-progress">
        <div class="progress-step completed">
            <div class="step-number">
                <i class="fas fa-check"></i>
            </div>
            <div class="step-label">Carrinho</div>
        </div>
        
        <div class="progress-step active">
            <div class="step-number">2</div>
            <div class="step-label">Informações</div>
        </div>
        
        <div class="progress-step">
            <div class="step-number">3</div>
            <div class="step-label">Pagamento</div>
        </div>
        
        <div class="progress-step">
            <div class="step-number">4</div>
            <div class="step-label">Confirmação</div>
        </div>
    </div>
    
    <form id="checkout-form" method="post">
        {% csrf_token %}
        <div class="row">
            <!-- Formulário de Checkout -->
            <div class="col-lg-8">
                <!-- Endereço de Entrega -->
                <div class="checkout-section">
                    <h3 class="section-title">
                        <i class="fas fa-map-marker-alt"></i>
                        Endereço de Entrega
                    </h3>
                    
                    {% if user.is_authenticated and user.addresses.all %}
                    <!-- Endereços Salvos -->
                    <div class="row mb-4">
                        {% for address in user.addresses.all %}
                        <div class="col-md-6">
                            <label class="address-card">
                                <input type="radio" name="shipping_address" value="{{ address.id }}" 
                                       {% if forloop.first %}checked{% endif %}>
                                <div class="address-info">
                                    <strong>{{ address.name }}</strong><br>
                                    {{ address.street }}, {{ address.number }}<br>
                                    {% if address.complement %}{{ address.complement }}<br>{% endif %}
                                    {{ address.neighborhood }} - {{ address.city }}/{{ address.state }}<br>
                                    CEP: {{ address.zip_code }}
                                </div>
                            </label>
                        </div>
                        {% endfor %}
                        
                        <div class="col-md-6">
                            <label class="address-card">
                                <input type="radio" name="shipping_address" value="new">
                                <div class="text-center">
                                    <i class="fas fa-plus fa-2x text-muted mb-2"></i><br>
                                    <strong>Novo Endereço</strong>
                                </div>
                            </label>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Formulário de Novo Endereço -->
                    <div id="new-address-form" {% if user.is_authenticated and user.addresses.all %}style="display: none;"{% endif %}>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="first_name" 
                                           name="first_name" placeholder="Nome" required>
                                    <label for="first_name">Nome *</label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="last_name" 
                                           name="last_name" placeholder="Sobrenome" required>
                                    <label for="last_name">Sobrenome *</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="zip_code" 
                                           name="zip_code" placeholder="CEP" required 
                                           maxlength="9" onblur="searchCEP(this.value)">
                                    <label for="zip_code">CEP *</label>
                                </div>
                            </div>
                            
                            <div class="col-md-8">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="street" 
                                           name="street" placeholder="Endereço" required>
                                    <label for="street">Endereço *</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="number" 
                                           name="number" placeholder="Número" required>
                                    <label for="number">Número *</label>
                                </div>
                            </div>
                            
                            <div class="col-md-9">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="complement" 
                                           name="complement" placeholder="Complemento">
                                    <label for="complement">Complemento</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="neighborhood" 
                                           name="neighborhood" placeholder="Bairro" required>
                                    <label for="neighborhood">Bairro *</label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="city" 
                                           name="city" placeholder="Cidade" required>
                                    <label for="city">Cidade *</label>
                                </div>
                            </div>
                            
                            <div class="col-md-2">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="state" 
                                           name="state" placeholder="UF" required maxlength="2">
                                    <label for="state">UF *</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Opções de Frete -->
                <div class="checkout-section">
                    <h3 class="section-title">
                        <i class="fas fa-truck"></i>
                        Opções de Frete
                    </h3>
                    
                    <div id="shipping-options">
                        <div class="text-center text-muted">
                            <i class="fas fa-map-marker-alt fa-2x mb-2"></i>
                            <p>Selecione um endereço para calcular o frete</p>
                        </div>
                    </div>
                </div>
                
                <!-- Forma de Pagamento -->
                <div class="checkout-section">
                    <h3 class="section-title">
                        <i class="fas fa-credit-card"></i>
                        Forma de Pagamento
                    </h3>
                    
                    <div class="payment-methods">
                        <label class="payment-method">
                            <input type="radio" name="payment_method" value="credit_card" checked>
                            <div class="payment-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <div class="payment-info">
                                <div class="payment-title">Cartão de Crédito</div>
                                <div class="payment-description">
                                    Visa, Mastercard, Elo, American Express
                                </div>
                            </div>
                        </label>
                        
                        <label class="payment-method">
                            <input type="radio" name="payment_method" value="pix">
                            <div class="payment-icon">
                                <i class="fas fa-qrcode"></i>
                            </div>
                            <div class="payment-info">
                                <div class="payment-title">PIX</div>
                                <div class="payment-description">
                                    Aprovação instantânea
                                </div>
                            </div>
                        </label>
                        
                        <label class="payment-method">
                            <input type="radio" name="payment_method" value="boleto">
                            <div class="payment-icon">
                                <i class="fas fa-barcode"></i>
                            </div>
                            <div class="payment-info">
                                <div class="payment-title">Boleto Bancário</div>
                                <div class="payment-description">
                                    Vencimento em 3 dias úteis
                                </div>
                            </div>
                        </label>
                    </div>
                    
                    <!-- Campos do Cartão de Crédito -->
                    <div id="credit-card-fields" class="mt-4">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="card_number" 
                                           name="card_number" placeholder="Número do Cartão">
                                    <label for="card_number">Número do Cartão</label>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="card_cvv" 
                                           name="card_cvv" placeholder="CVV" maxlength="4">
                                    <label for="card_cvv">CVV</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="card_name" 
                                           name="card_name" placeholder="Nome no Cartão">
                                    <label for="card_name">Nome no Cartão</label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="card_expiry" 
                                           name="card_expiry" placeholder="MM/AA" maxlength="5">
                                    <label for="card_expiry">Validade (MM/AA)</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Observações -->
                <div class="checkout-section">
                    <h3 class="section-title">
                        <i class="fas fa-comment"></i>
                        Observações
                    </h3>
                    
                    <div class="form-floating">
                        <textarea class="form-control" id="notes" name="notes" 
                                  placeholder="Observações" style="height: 100px;"></textarea>
                        <label for="notes">Observações sobre o pedido (opcional)</label>
                    </div>
                </div>
            </div>
            
            <!-- Resumo do Pedido -->
            <div class="col-lg-4">
                <div class="order-summary">
                    <h4 class="mb-3">Resumo do Pedido</h4>
                    
                    <!-- Itens do Carrinho -->
                    <div class="order-items">
                        {% for item in cart %}
                        <div class="order-item">
                            {% if item.product.images.all %}
                                {% with item.product.images.all|first as image %}
                                <img src="{{ image.image.url }}" alt="{{ item.product.name }}" class="item-image">
                                {% endwith %}
                            {% else %}
                                <div class="item-image bg-light d-flex align-items-center justify-content-center">
                                    <i class="fas fa-image text-muted"></i>
                                </div>
                            {% endif %}
                            
                            <div class="item-info">
                                <div class="item-name">{{ item.product.name }}</div>
                                <div class="item-details">
                                    Qtd: {{ item.quantity }} × R$ {{ item.price }}
                                </div>
                            </div>
                            
                            <div class="item-price">
                                R$ {{ item.total_price }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Cupom de Desconto -->
                    <div class="coupon-section">
                        <h6>Cupom de Desconto</h6>
                        <div class="coupon-input">
                            <input type="text" class="form-control" id="coupon-code" 
                                   placeholder="Código do cupom">
                            <button type="button" class="btn btn-outline-primary" 
                                    onclick="applyCoupon()">Aplicar</button>
                        </div>
                        <div id="coupon-message" class="mt-2"></div>
                    </div>
                    
                    <hr>
                    
                    <!-- Resumo de Valores -->
                    <div class="order-totals">
                        <div class="summary-line">
                            <span>Subtotal:</span>
                            <span>R$ <span id="subtotal">{{ cart.get_total_price }}</span></span>
                        </div>
                        
                        <div class="summary-line">
                            <span>Frete:</span>
                            <span id="shipping-cost">A calcular</span>
                        </div>
                        
                        <div class="summary-line" id="discount-line" style="display: none;">
                            <span>Desconto:</span>
                            <span class="text-success">-R$ <span id="discount-amount">0,00</span></span>
                        </div>
                        
                        <div class="summary-line total">
                            <span>Total:</span>
                            <span class="text-primary">R$ <span id="total-amount">{{ cart.get_total_price }}</span></span>
                        </div>
                    </div>
                    
                    <!-- Termos e Condições -->
                    <div class="terms-checkbox">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   id="accept-terms" name="accept_terms" required>
                            <label class="form-check-label" for="accept-terms">
                                Aceito os <a href="#" target="_blank">termos e condições</a> 
                                e a <a href="#" target="_blank">política de privacidade</a>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Botão Finalizar -->
                    <button type="submit" class="place-order-btn" id="place-order-btn">
                        <i class="fas fa-lock me-2"></i>
                        Finalizar Pedido
                    </button>
                    
                    <!-- Badges de Segurança -->
                    <div class="security-badges">
                        <div class="security-badge">
                            <i class="fas fa-shield-alt"></i>
                            Compra Segura
                        </div>
                        <div class="security-badge">
                            <i class="fas fa-lock"></i>
                            SSL Criptografado
                        </div>
                        <div class="security-badge">
                            <i class="fas fa-undo"></i>
                            7 Dias para Troca
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Modal de Loading -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <h5>Processando seu pedido...</h5>
                <p class="text-muted mb-0">Por favor, aguarde enquanto finalizamos sua compra.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Máscaras para campos
    const cepInput = document.getElementById('zip_code');
    if (cepInput) {
        cepInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.replace(/^(\d{5})(\d{1,3}).*/, '$1-$2');
            }
            e.target.value = value;
        });
    }
    
    const cardNumber = document.getElementById('card_number');
    if (cardNumber) {
        cardNumber.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
            e.target.value = value;
        });
    }
    
    const cardExpiry = document.getElementById('card_expiry');
    if (cardExpiry) {
        cardExpiry.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.replace(/^(\d{2})(\d{0,2}).*/, '$1/$2');
            }
            e.target.value = value;
        });
    }
    
    // Controle de exibição dos campos de pagamento
    const paymentMethods = document.querySelectorAll('input[name="payment_method"]');
    const creditCardFields = document.getElementById('credit-card-fields');
    
    paymentMethods.forEach(method => {
        method.addEventListener('change', function() {
            if (this.value === 'credit_card') {
                creditCardFields.style.display = 'block';
                setRequiredFields(true);
            } else {
                creditCardFields.style.display = 'none';
                setRequiredFields(false);
            }
        });
    });
    
    // Controle de endereços
    const addressRadios = document.querySelectorAll('input[name="shipping_address"]');
    const newAddressForm = document.getElementById('new-address-form');
    
    addressRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'new') {
                newAddressForm.style.display = 'block';
                calculateShipping();
            } else {
                newAddressForm.style.display = 'none';
                calculateShippingForAddress(this.value);
            }
        });
    });
    
    // Validação do formulário
    const checkoutForm = document.getElementById('checkout-form');
    checkoutForm.addEventListener('submit', function(e) {
        e.preventDefault();
        processOrder();
    });
});

function setRequiredFields(required) {
    const fields = ['card_number', 'card_name', 'card_expiry', 'card_cvv'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.required = required;
        }
    });
}

function searchCEP(cep) {
    cep = cep.replace(/\D/g, '');
    
    if (cep.length === 8) {
        // Consulta ViaCEP
        fetch(`https://viacep.com.br/ws/${cep}/json/`)
            .then(response => response.json())
            .then(data => {
                if (!data.erro) {
                    document.getElementById('street').value = data.logradouro;
                    document.getElementById('neighborhood').value = data.bairro;
                    document.getElementById('city').value = data.localidade;
                    document.getElementById('state').value = data.uf;
                    
                    calculateShipping();
                } else {
                    showToast('CEP não encontrado.', 'error');
                }
            })
            .catch(error => {
                console.error('Erro ao consultar CEP:', error);
                showToast('Erro ao consultar CEP.', 'error');
            });
    }
}

function calculateShipping() {
    const cep = document.getElementById('zip_code')?.value.replace(/\D/g, '');
    
    if (cep && cep.length === 8) {
        const shippingOptions = document.getElementById('shipping-options');
        shippingOptions.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Calculando frete...</div>';
        
        // Simulated shipping calculation
        setTimeout(() => {
            shippingOptions.innerHTML = `
                <div class="shipping-option selected" onclick="selectShipping(this, 8.50)">
                    <input type="radio" name="shipping_method" value="pac" checked>
                    <div class="shipping-info">
                        <div class="shipping-details">
                            <div class="shipping-name">PAC</div>
                            <div class="shipping-time">Até 10 dias úteis</div>
                        </div>
                        <div class="shipping-price">R$ 8,50</div>
                    </div>
                </div>
                
                <div class="shipping-option" onclick="selectShipping(this, 15.80)">
                    <input type="radio" name="shipping_method" value="sedex">
                    <div class="shipping-info">
                        <div class="shipping-details">
                            <div class="shipping-name">SEDEX</div>
                            <div class="shipping-time">Até 3 dias úteis</div>
                        </div>
                        <div class="shipping-price">R$ 15,80</div>
                    </div>
                </div>
            `;
            
            updateShippingCost(8.50);
        }, 1500);
    }
}

function calculateShippingForAddress(addressId) {
    // Simulate API call for saved address
    setTimeout(() => {
        const shippingOptions = document.getElementById('shipping-options');
        shippingOptions.innerHTML = `
            <div class="shipping-option selected" onclick="selectShipping(this, 8.50)">
                <input type="radio" name="shipping_method" value="pac" checked>
                <div class="shipping-info">
                    <div class="shipping-details">
                        <div class="shipping-name">PAC</div>
                        <div class="shipping-time">Até 10 dias úteis</div>
                    </div>
                    <div class="shipping-price">R$ 8,50</div>
                </div>
            </div>
        `;
        
        updateShippingCost(8.50);
    }, 500);
}

function selectShipping(element, cost) {
    document.querySelectorAll('.shipping-option').forEach(option => {
        option.classList.remove('selected');
        option.querySelector('input').checked = false;
    });
    
    element.classList.add('selected');
    element.querySelector('input').checked = true;
    
    updateShippingCost(cost);
}

function updateShippingCost(cost) {
    document.getElementById('shipping-cost').textContent = `R$ ${cost.toFixed(2)}`;
    updateTotal();
}

function applyCoupon() {
    const couponCode = document.getElementById('coupon-code').value.trim();
    const messageDiv = document.getElementById('coupon-message');
    
    if (!couponCode) {
        showMessage(messageDiv, 'Digite um código de cupom.', 'error');
        return;
    }
    
    // Simulate coupon validation
    if (couponCode.toLowerCase() === 'desc10') {
        const discount = 10.00;
        document.getElementById('discount-amount').textContent = discount.toFixed(2);
        document.getElementById('discount-line').style.display = 'flex';
        showMessage(messageDiv, 'Cupom aplicado com sucesso!', 'success');
        updateTotal();
    } else {
        showMessage(messageDiv, 'Cupom inválido ou expirado.', 'error');
    }
}

function showMessage(element, message, type) {
    element.innerHTML = `<small class="text-${type === 'success' ? 'success' : 'danger'}">${message}</small>`;
}

function updateTotal() {
    const subtotal = parseFloat(document.getElementById('subtotal').textContent);
    const shippingText = document.getElementById('shipping-cost').textContent;
    const shipping = shippingText.includes('R$') ? parseFloat(shippingText.replace('R$ ', '')) : 0;
    const discount = parseFloat(document.getElementById('discount-amount').textContent) || 0;
    
    const total = subtotal + shipping - discount;
    document.getElementById('total-amount').textContent = total.toFixed(2);
}

function processOrder() {
    const form = document.getElementById('checkout-form');
    const formData = new FormData(form);
    
    // Validate required fields
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        showToast('Preencha todos os campos obrigatórios.', 'error');
        return;
    }
    
    // Show loading modal
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    // Submit order
    fetch(form.action || window.location.pathname, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        loadingModal.hide();
        
        if (data.success) {
            window.location.href = data.redirect_url || `/pedidos/${data.order_id}/confirmacao/`;
        } else {
            showToast(data.message || 'Erro ao processar pedido.', 'error');
        }
    })
    .catch(error => {
        loadingModal.hide();
        console.error('Error:', error);
        showToast('Erro ao processar pedido. Tente novamente.', 'error');
    });
}

function showToast(message, type) {
    // Simple toast implementation
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close float-end" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}
</script>
{% endblock %}