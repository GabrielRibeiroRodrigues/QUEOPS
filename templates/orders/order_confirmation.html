{% extends 'base.html' %}
{% load static %}

{% block title %}Pedido Confirmado - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .confirmation-header {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 60px 0;
        text-align: center;
        margin-bottom: 40px;
    }
    
    .success-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .order-details {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.08);
    }
    
    .order-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 10px;
    }
    
    .order-status {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-confirmed {
        background: #d4edda;
        color: #155724;
    }
    
    .status-processing {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-shipped {
        background: #cce7ff;
        color: #004085;
    }
    
    .order-timeline {
        position: relative;
        padding-left: 30px;
    }
    
    .order-timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #dee2e6;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 30px;
        padding-bottom: 20px;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -23px;
        top: 5px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #28a745;
        border: 3px solid white;
        box-shadow: 0 0 0 3px #28a745;
    }
    
    .timeline-item.pending::before {
        background: #dee2e6;
        box-shadow: 0 0 0 3px #dee2e6;
    }
    
    .timeline-content {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 3px solid #28a745;
    }
    
    .timeline-item.pending .timeline-content {
        border-left-color: #dee2e6;
    }
    
    .timeline-title {
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .timeline-description {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    
    .timeline-date {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .order-items {
        margin-top: 30px;
    }
    
    .item-row {
        display: flex;
        align-items: center;
        padding: 20px 0;
        border-bottom: 1px solid #eee;
    }
    
    .item-row:last-child {
        border-bottom: none;
    }
    
    .item-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 20px;
    }
    
    .item-info {
        flex: 1;
    }
    
    .item-name {
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .item-details {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .item-price {
        font-weight: 600;
        color: #28a745;
        text-align: right;
        min-width: 100px;
    }
    
    .order-summary-table {
        margin-top: 20px;
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }
    
    .summary-row.total {
        font-weight: bold;
        font-size: 1.2rem;
        border-bottom: none;
        border-top: 2px solid #dee2e6;
        margin-top: 10px;
        padding-top: 15px;
    }
    
    .address-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .info-section {
        margin-bottom: 30px;
    }
    
    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #495057;
        display: flex;
        align-items: center;
    }
    
    .section-title i {
        margin-right: 10px;
        color: #007bff;
    }
    
    .payment-info {
        display: flex;
        align-items: center;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
    }
    
    .payment-icon {
        font-size: 2rem;
        margin-right: 15px;
        color: #007bff;
    }
    
    .next-steps {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 8px;
        padding: 25px;
        margin: 30px 0;
    }
    
    .next-steps h5 {
        color: #1976d2;
        margin-bottom: 15px;
    }
    
    .next-steps ul {
        margin-bottom: 0;
    }
    
    .next-steps li {
        margin-bottom: 8px;
    }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin: 40px 0;
        flex-wrap: wrap;
    }
    
    .btn-custom {
        padding: 12px 30px;
        font-weight: 600;
        border-radius: 25px;
        text-decoration: none;
        transition: all 0.3s;
    }
    
    .btn-primary-custom {
        background: #007bff;
        color: white;
        border: 2px solid #007bff;
    }
    
    .btn-primary-custom:hover {
        background: #0056b3;
        border-color: #0056b3;
        color: white;
        transform: translateY(-2px);
    }
    
    .btn-outline-custom {
        background: transparent;
        color: #007bff;
        border: 2px solid #007bff;
    }
    
    .btn-outline-custom:hover {
        background: #007bff;
        color: white;
        transform: translateY(-2px);
    }
    
    .contact-info {
        text-align: center;
        background: #f8f9fa;
        padding: 30px;
        border-radius: 8px;
        margin-top: 30px;
    }
    
    .contact-info h5 {
        margin-bottom: 20px;
        color: #495057;
    }
    
    .contact-methods {
        display: flex;
        justify-content: center;
        gap: 30px;
        flex-wrap: wrap;
    }
    
    .contact-method {
        display: flex;
        align-items: center;
        text-decoration: none;
        color: #6c757d;
        transition: color 0.3s;
    }
    
    .contact-method:hover {
        color: #007bff;
    }
    
    .contact-method i {
        margin-right: 8px;
        font-size: 1.2rem;
    }
    
    @media (max-width: 768px) {
        .confirmation-header {
            padding: 40px 0;
        }
        
        .success-icon {
            font-size: 3rem;
        }
        
        .action-buttons {
            flex-direction: column;
            align-items: center;
        }
        
        .btn-custom {
            width: 100%;
            max-width: 300px;
        }
        
        .contact-methods {
            flex-direction: column;
            gap: 15px;
        }
        
        .item-row {
            flex-direction: column;
            text-align: center;
        }
        
        .item-image {
            margin: 0 0 15px 0;
        }
        
        .item-price {
            text-align: center;
            margin-top: 10px;
        }
    }
    
    .print-button {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #007bff;
        color: white;
        border: none;
        font-size: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        transition: all 0.3s;
        z-index: 1000;
    }
    
    .print-button:hover {
        background: #0056b3;
        transform: scale(1.1);
    }
    
    @media print {
        .print-button, .action-buttons, .contact-info {
            display: none;
        }
        
        .confirmation-header {
            background: #28a745 !important;
            -webkit-print-color-adjust: exact;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header de Confirmação -->
<div class="confirmation-header">
    <div class="container">
        <div class="success-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <h1 class="mb-3">Pedido Realizado com Sucesso!</h1>
        <p class="lead mb-0">
            Obrigado pela sua compra! Seu pedido foi confirmado e está sendo processado.
        </p>
    </div>
</div>

<div class="container pb-5">
    <div class="row">
        <!-- Detalhes do Pedido -->
        <div class="col-lg-8">
            <div class="order-details">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <div class="order-number">Pedido #{{ order.order_number }}</div>
                        <p class="text-muted mb-0">Realizado em {{ order.created_at|date:"d/m/Y às H:i" }}</p>
                    </div>
                    <span class="order-status status-{{ order.status }}">
                        {% if order.status == 'confirmed' %}
                            Confirmado
                        {% elif order.status == 'processing' %}
                            Processando
                        {% elif order.status == 'shipped' %}
                            Enviado
                        {% elif order.status == 'delivered' %}
                            Entregue
                        {% else %}
                            {{ order.get_status_display }}
                        {% endif %}
                    </span>
                </div>
                
                <!-- Timeline do Pedido -->
                <div class="order-timeline">
                    <div class="timeline-item">
                        <div class="timeline-content">
                            <div class="timeline-title">Pedido Confirmado</div>
                            <div class="timeline-description">
                                Seu pedido foi recebido e está sendo processado.
                            </div>
                            <div class="timeline-date">{{ order.created_at|date:"d/m/Y H:i" }}</div>
                        </div>
                    </div>
                    
                    <div class="timeline-item {% if order.status == 'confirmed' %}pending{% endif %}">
                        <div class="timeline-content">
                            <div class="timeline-title">Pagamento Processado</div>
                            <div class="timeline-description">
                                {% if order.payment_method == 'pix' %}
                                    Pagamento via PIX confirmado.
                                {% elif order.payment_method == 'credit_card' %}
                                    Pagamento no cartão de crédito aprovado.
                                {% elif order.payment_method == 'boleto' %}
                                    Aguardando confirmação do pagamento do boleto.
                                {% else %}
                                    Processando pagamento.
                                {% endif %}
                            </div>
                            <div class="timeline-date">
                                {% if order.status != 'confirmed' %}
                                    {{ order.updated_at|date:"d/m/Y H:i" }}
                                {% else %}
                                    Aguardando
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="timeline-item pending">
                        <div class="timeline-content">
                            <div class="timeline-title">Preparando para Envio</div>
                            <div class="timeline-description">
                                Seus produtos estão sendo separados e embalados.
                            </div>
                            <div class="timeline-date">Aguardando</div>
                        </div>
                    </div>
                    
                    <div class="timeline-item pending">
                        <div class="timeline-content">
                            <div class="timeline-title">Enviado</div>
                            <div class="timeline-description">
                                Seu pedido foi enviado e está a caminho.
                            </div>
                            <div class="timeline-date">Aguardando</div>
                        </div>
                    </div>
                    
                    <div class="timeline-item pending">
                        <div class="timeline-content">
                            <div class="timeline-title">Entregue</div>
                            <div class="timeline-description">
                                Pedido entregue no endereço de destino.
                            </div>
                            <div class="timeline-date">Aguardando</div>
                        </div>
                    </div>
                </div>
                
                <!-- Próximos Passos -->
                {% if order.payment_method == 'boleto' and order.status == 'confirmed' %}
                <div class="next-steps">
                    <h5><i class="fas fa-exclamation-circle me-2"></i>Próximos Passos</h5>
                    <ul>
                        <li>O boleto foi enviado para seu e-mail</li>
                        <li>Pague o boleto até a data de vencimento</li>
                        <li>Após a confirmação do pagamento, seu pedido será processado</li>
                        <li>Você receberá um e-mail quando o pedido for enviado</li>
                    </ul>
                </div>
                {% elif order.payment_method == 'pix' and order.status == 'confirmed' %}
                <div class="next-steps">
                    <h5><i class="fas fa-qrcode me-2"></i>Pagamento PIX</h5>
                    <ul>
                        <li>Use o código PIX enviado para seu e-mail</li>
                        <li>O pagamento será confirmado instantaneamente</li>
                        <li>Seu pedido será processado automaticamente após o pagamento</li>
                    </ul>
                </div>
                {% else %}
                <div class="next-steps">
                    <h5><i class="fas fa-info-circle me-2"></i>O que Acontece Agora?</h5>
                    <ul>
                        <li>Você receberá um e-mail de confirmação com todos os detalhes</li>
                        <li>Acompanhe o status do seu pedido em "Meus Pedidos"</li>
                        <li>Enviaremos atualizações por e-mail a cada etapa</li>
                        <li>Em caso de dúvidas, entre em contato conosco</li>
                    </ul>
                </div>
                {% endif %}
                
                <!-- Itens do Pedido -->
                <div class="order-items">
                    <h4 class="section-title">
                        <i class="fas fa-shopping-bag"></i>
                        Itens do Pedido
                    </h4>
                    
                    {% for item in order.items.all %}
                    <div class="item-row">
                        {% if item.product.images.all %}
                            {% with item.product.images.all|first as image %}
                            <img src="{{ image.image.url }}" alt="{{ item.product.name }}" class="item-image">
                            {% endwith %}
                        {% else %}
                            <div class="item-image bg-light d-flex align-items-center justify-content-center">
                                <i class="fas fa-image text-muted"></i>
                            </div>
                        {% endif %}
                        
                        <div class="item-info">
                            <div class="item-name">{{ item.product.name }}</div>
                            <div class="item-details">
                                Quantidade: {{ item.quantity }} × R$ {{ item.price|floatformat:2 }}
                                {% if item.product.sku %}
                                <br>SKU: {{ item.product.sku }}
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="item-price">
                            R$ {{ item.get_total_price|floatformat:2 }}
                        </div>
                    </div>
                    {% endfor %}
                    
                    <!-- Resumo de Valores -->
                    <div class="order-summary-table">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span>R$ {{ order.get_subtotal|floatformat:2 }}</span>
                        </div>
                        
                        <div class="summary-row">
                            <span>Frete:</span>
                            <span>R$ {{ order.shipping_cost|floatformat:2 }}</span>
                        </div>
                        
                        {% if order.discount_amount > 0 %}
                        <div class="summary-row">
                            <span>Desconto:</span>
                            <span class="text-success">-R$ {{ order.discount_amount|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                        
                        <div class="summary-row total">
                            <span>Total:</span>
                            <span class="text-primary">R$ {{ order.total_amount|floatformat:2 }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Informações Laterais -->
        <div class="col-lg-4">
            <!-- Endereço de Entrega -->
            <div class="info-section">
                <h4 class="section-title">
                    <i class="fas fa-map-marker-alt"></i>
                    Endereço de Entrega
                </h4>
                
                <div class="address-info">
                    <strong>{{ order.shipping_name }}</strong><br>
                    {{ order.shipping_address }}<br>
                    {{ order.shipping_city }}, {{ order.shipping_state }}<br>
                    CEP: {{ order.shipping_zip_code }}
                    {% if order.shipping_phone %}
                    <br>Tel: {{ order.shipping_phone }}
                    {% endif %}
                </div>
            </div>
            
            <!-- Forma de Pagamento -->
            <div class="info-section">
                <h4 class="section-title">
                    <i class="fas fa-credit-card"></i>
                    Forma de Pagamento
                </h4>
                
                <div class="payment-info">
                    {% if order.payment_method == 'credit_card' %}
                        <div class="payment-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div>
                            <strong>Cartão de Crédito</strong><br>
                            <small class="text-muted">
                                Final {{ order.card_last_four_digits|default:"****" }}
                            </small>
                        </div>
                    {% elif order.payment_method == 'pix' %}
                        <div class="payment-icon">
                            <i class="fas fa-qrcode"></i>
                        </div>
                        <div>
                            <strong>PIX</strong><br>
                            <small class="text-muted">Pagamento instantâneo</small>
                        </div>
                    {% elif order.payment_method == 'boleto' %}
                        <div class="payment-icon">
                            <i class="fas fa-barcode"></i>
                        </div>
                        <div>
                            <strong>Boleto Bancário</strong><br>
                            <small class="text-muted">Vencimento em 3 dias úteis</small>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Frete -->
            <div class="info-section">
                <h4 class="section-title">
                    <i class="fas fa-truck"></i>
                    Informações de Entrega
                </h4>
                
                <div class="address-info">
                    <strong>{{ order.get_shipping_method_display|default:"Frete Padrão" }}</strong><br>
                    <small class="text-muted">
                        {% if order.shipping_method == 'express' %}
                            Entrega em até 3 dias úteis
                        {% else %}
                            Entrega em até 10 dias úteis
                        {% endif %}
                    </small>
                    
                    {% if order.tracking_code %}
                    <hr>
                    <strong>Código de Rastreamento:</strong><br>
                    <code>{{ order.tracking_code }}</code>
                    <br>
                    <a href="#" class="btn btn-sm btn-outline-primary mt-2">
                        Rastrear Pedido
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Botões de Ação -->
    <div class="action-buttons">
        <a href="{% url 'accounts:orders' %}" class="btn-custom btn-primary-custom">
            <i class="fas fa-list-ul me-2"></i>Meus Pedidos
        </a>
        
        <a href="{% url 'store:product_list' %}" class="btn-custom btn-outline-custom">
            <i class="fas fa-shopping-bag me-2"></i>Continuar Comprando
        </a>
        
        {% if order.payment_method == 'boleto' and order.status == 'confirmed' %}
        <a href="#" class="btn-custom btn-outline-custom">
            <i class="fas fa-download me-2"></i>Baixar Boleto
        </a>
        {% endif %}
    </div>
    
    <!-- Informações de Contato -->
    <div class="contact-info">
        <h5>Precisa de Ajuda?</h5>
        <p class="text-muted mb-3">
            Nossa equipe está pronta para ajudar você com qualquer dúvida sobre seu pedido.
        </p>
        
        <div class="contact-methods">
            <a href="tel:+5511999999999" class="contact-method">
                <i class="fas fa-phone"></i>
                (11) 9999-9999
            </a>
            
            <a href="mailto:contato@loja.com" class="contact-method">
                <i class="fas fa-envelope"></i>
                contato@loja.com
            </a>
            
            <a href="#" class="contact-method">
                <i class="fab fa-whatsapp"></i>
                WhatsApp
            </a>
        </div>
    </div>
</div>

<!-- Botão de Imprimir -->
<button class="print-button" onclick="window.print()" title="Imprimir pedido">
    <i class="fas fa-print"></i>
</button>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animar timeline items quando visíveis
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateX(0)';
            }
        });
    }, observerOptions);
    
    document.querySelectorAll('.timeline-item').forEach(item => {
        item.style.opacity = '0';
        item.style.transform = 'translateX(-20px)';
        item.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(item);
    });
    
    // Auto-refresh para pedidos pendentes
    {% if order.status == 'confirmed' and order.payment_method == 'pix' %}
    setTimeout(function() {
        checkPaymentStatus();
    }, 30000); // Check after 30 seconds
    {% endif %}
});

{% if order.status == 'confirmed' and order.payment_method == 'pix' %}
function checkPaymentStatus() {
    fetch(`/api/orders/{{ order.id }}/status/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status !== 'confirmed') {
            location.reload(); // Reload if status changed
        } else {
            // Check again in 30 seconds
            setTimeout(checkPaymentStatus, 30000);
        }
    })
    .catch(error => {
        console.error('Error checking payment status:', error);
    });
}
{% endif %}

// Print optimization
window.addEventListener('beforeprint', function() {
    document.body.classList.add('printing');
});

window.addEventListener('afterprint', function() {
    document.body.classList.remove('printing');
});
</script>
{% endblock %}