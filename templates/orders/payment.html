{% extends 'base.html' %}
{% load static %}

{% block title %}Pagamento - Pedido #{{ order.order_number }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .payment-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .payment-header {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .order-summary-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .payment-methods {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .payment-method {
        border: 2px solid #e9ecef;
            border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .payment-method:hover {
        border-color: #007bff;
        background: #f8f9ff;
    }
    
    .payment-method.selected {
        border-color: #007bff;
        background: #e3f2fd;
        box-shadow: 0 4px 15px rgba(0,123,255,0.2);
    }
    
    .payment-method-info {
        display: flex;
        align-items: center;
    }
    
    .payment-icon {
        width: 50px;
        height: 50px;
        background: #007bff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        margin-right: 15px;
        font-size: 1.5rem;
    }
    
    .payment-details h6 {
        margin: 0;
        font-weight: 600;
    }
    
    .payment-details small {
        color: #666;
    }
    
    .order-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .order-item:last-child {
        border-bottom: none;
    }
    
    .total-line {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }
    
    .total-line.final {
        font-weight: bold;
        font-size: 1.2rem;
        color: #007bff;
        border-top: 2px solid #007bff;
        padding-top: 15px;
        margin-top: 15px;
    }
    
    .btn-pay {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: none;
        padding: 15px 30px;
        font-size: 1.1rem;
        font-weight: bold;
        border-radius: 8px;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 20px;
    }
    
    .btn-pay:hover {
        background: linear-gradient(45deg, #20c997, #17a2b8);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40,167,69,0.3);
    }
    
    .btn-pay:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .payment-security {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        text-align: center;
    }
    
    .security-badges {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 15px;
        flex-wrap: wrap;
    }
    
    .security-badge {
        display: flex;
        align-items: center;
        gap: 5px;
        color: #28a745;
        font-size: 0.9rem;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .loading-content {
        background: white;
        padding: 40px;
        border-radius: 10px;
        text-align: center;
        max-width: 300px;
    }
    
    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
        .payment-container {
            padding: 10px;
        }
        
        .payment-method {
            flex-direction: column;
            text-align: center;
        }
        
        .payment-method-info {
            margin-bottom: 10px;
        }
        
        .security-badges {
            flex-direction: column;
            align-items: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="payment-container">
    <div class="payment-header">
        <h2>
            <i class="fas fa-credit-card me-2"></i>
            Pagamento
        </h2>
        <p class="mb-0">Pedido #{{ order.order_number }}</p>
    </div>
    
    <!-- Resumo do Pedido -->
    <div class="order-summary-card">
        <h5 class="mb-3">
            <i class="fas fa-receipt me-2"></i>
            Resumo do Pedido
        </h5>
        
        {% for item in order.items.all %}
        <div class="order-item">
            <div>
                <strong>{{ item.product_name }}</strong><br>
                <small class="text-muted">Quantidade: {{ item.quantity }}</small>
            </div>
            <div class="text-end">
                <strong>R$ {{ item.total_price|floatformat:2 }}</strong>
            </div>
        </div>
        {% endfor %}
        
        <div class="mt-3">
            <div class="total-line">
                <span>Subtotal:</span>
                <span>R$ {{ order.subtotal|floatformat:2 }}</span>
            </div>
            
            {% if order.shipping_cost > 0 %}
            <div class="total-line">
                <span>Frete:</span>
                <span>R$ {{ order.shipping_cost|floatformat:2 }}</span>
            </div>
            {% endif %}
            
            <div class="total-line final">
                <span>Total:</span>
                <span>R$ {{ order.total|floatformat:2 }}</span>
            </div>
        </div>
    </div>
    
    <!-- Métodos de Pagamento -->
    <div class="payment-methods">
        <h5 class="mb-4">
            <i class="fas fa-credit-card me-2"></i>
            Escolha a forma de pagamento
        </h5>
        
        <div class="payment-method selected" data-method="credit_card">
            <div class="payment-method-info">
                <div class="payment-icon">
                    <i class="fas fa-credit-card"></i>
                </div>
                <div class="payment-details">
                    <h6>Cartão de Crédito</h6>
                    <small>Visa, Mastercard, Elo, Amex</small>
                </div>
            </div>
            <div class="text-success">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
        
        <div class="payment-method" data-method="pix">
            <div class="payment-method-info">
                <div class="payment-icon">
                    <i class="fas fa-qrcode"></i>
                </div>
                <div class="payment-details">
                    <h6>PIX</h6>
                    <small>Pagamento instantâneo</small>
                </div>
            </div>
        </div>
        
        <div class="payment-method" data-method="boleto">
            <div class="payment-method-info">
                <div class="payment-icon">
                    <i class="fas fa-barcode"></i>
                </div>
                <div class="payment-details">
                    <h6>Boleto Bancário</h6>
                    <small>Vencimento em 3 dias úteis</small>
                </div>
            </div>
        </div>
        
        <button id="pay-button" class="btn btn-primary btn-pay">
            <i class="fas fa-shield-alt me-2"></i>
            Pagar com Segurança
        </button>
        
        <div class="payment-security">
            <div class="text-muted">
                <i class="fas fa-lock me-2"></i>
                Pagamento 100% seguro e criptografado
            </div>
            
            <div class="security-badges">
                <div class="security-badge">
                    <i class="fas fa-shield-alt"></i>
                    <span>SSL Certificado</span>
                </div>
                <div class="security-badge">
                    <i class="fas fa-credit-card"></i>
                    <span>PCI Compliant</span>
                </div>
                <div class="security-badge">
                    <i class="fas fa-lock"></i>
                    <span>Dados Protegidos</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h5>Processando pagamento...</h5>
        <p class="text-muted">Aguarde, estamos redirecionando você para o pagamento.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://sdk.mercadopago.com/js/v2"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configurar SDK do Mercado Pago
    const mp = new MercadoPago('{{ mercadopago_public_key }}', {
        locale: 'pt-BR'
    });
    
    // Gerenciar seleção de método de pagamento
    const paymentMethods = document.querySelectorAll('.payment-method');
    let selectedMethod = 'credit_card';
    
    paymentMethods.forEach(method => {
        method.addEventListener('click', function() {
            // Remove seleção anterior
            paymentMethods.forEach(m => m.classList.remove('selected'));
            
            // Adiciona seleção atual
            this.classList.add('selected');
            selectedMethod = this.dataset.method;
            
            // Atualiza ícone de check
            paymentMethods.forEach(m => {
                const check = m.querySelector('.fa-check-circle');
                if (check) check.remove();
            });
            
            const checkIcon = document.createElement('div');
            checkIcon.className = 'text-success';
            checkIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            this.appendChild(checkIcon);
        });
    });
    
    // Processar pagamento
    const payButton = document.getElementById('pay-button');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    payButton.addEventListener('click', function() {
        this.disabled = true;
        loadingOverlay.style.display = 'flex';
        
        // Criar preferência de pagamento
        fetch('{% url "orders:create_payment" order_id=order.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                payment_method: selectedMethod
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Redirecionar para o Mercado Pago
                window.location.href = data.init_point;
            } else {
                throw new Error(data.message || 'Erro ao processar pagamento');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao processar pagamento: ' + error.message);
            
            // Reabilitar botão e esconder loading
            payButton.disabled = false;
            loadingOverlay.style.display = 'none';
        });
    });
    
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
               document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
               '';
    }
    
    // Adicionar meta tag CSRF se não existir
    if (!document.querySelector('meta[name="csrf-token"]')) {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            const meta = document.createElement('meta');
            meta.name = 'csrf-token';
            meta.content = csrfInput.value;
            document.head.appendChild(meta);
        }
    }
    
    // Animação de entrada
    const cards = document.querySelectorAll('.order-summary-card, .payment-methods');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 200);
    });
});
</script>
{% endblock %}